{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Windows 2012 R2 Base - IIS Autoscale (7-27-2016)",
    "Parameters": {
        "KeyName": {
            "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
            "Type" : "AWS::EC2::KeyPair::KeyName",
            "Default": ""
        },
        "RDPSecurityGroup" : {
            "Description" : "Select Security Group for RDP Access",
            "Type": "AWS::EC2::SecurityGroup::Id",
            "Default": ""
        },
        "VPC": {
            "Description" : "Choose VPC to use",
            "Type" : "AWS::EC2::VPC::Id",
            "Default": ""
        },
        "UserDataScript": {
            "Description" : "Enter URL for User Data script",
            "Type": "String",
            "Default": ""
        },
        "SubnetA": {
            "Description" : "Choose Availability Zone to use",
            "Type" : "AWS::EC2::Subnet::Id",
            "Default": ""
        },
        "SubnetB": {
            "Description" : "Choose Availability Zone to use",
            "Type" : "AWS::EC2::Subnet::Id",
            "Default": ""
        },
        "SubnetC": {
            "Description" : "Choose Availability Zone to use",
            "Type" : "AWS::EC2::Subnet::Id",
            "Default": ""
        },
        "InstanceType": {
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t2.micro",
                "t2.small",
                "t2.medium",
                "m3.medium",
                "m3.large",
                "m3.xlarge",
                "m3.2xlarge",
                "c3.large",
                "c3.xlarge",
                "c3.2xlarge",
                "c3.4xlarge",
                "c3.8xlarge",
                "c4.large",
                "c4.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "g2.2xlarge",
                "r3.large",
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge",
                "i2.xlarge",
                "i2.2xlarge",
                "i2.4xlarge",
                "i2.8xlarge",
                "d2.xlarge",
                "d2.2xlarge",
                "d2.4xlarge",
                "d2.8xlarge",
                "hi1.4xlarge",
                "hs1.8xlarge",
                "cr1.8xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge"
            ],
            "ConstraintDescription": "must be a valid EC2 instance type."
        }
    },
    "Mappings" : {
        "AWSInstanceType2Arch" : {
            "t2.micro"    : { "Arch" : "HVM64"  },
            "t2.small"    : { "Arch" : "HVM64"  },
            "t2.medium"   : { "Arch" : "HVM64"  },
            "t2.large"    : { "Arch" : "HVM64"  },
            "m1.small"    : { "Arch" : "HVM64"  },
            "m1.medium"   : { "Arch" : "HVM64"  },
            "m1.large"    : { "Arch" : "HVM64"  },
            "m1.xlarge"   : { "Arch" : "HVM64"  },
            "m2.xlarge"   : { "Arch" : "HVM64"  },
            "m2.2xlarge"  : { "Arch" : "HVM64"  },
            "m2.4xlarge"  : { "Arch" : "HVM64"  },
            "m3.medium"   : { "Arch" : "HVM64"  },
            "m3.large"    : { "Arch" : "HVM64"  },
            "m3.xlarge"   : { "Arch" : "HVM64"  },
            "m3.2xlarge"  : { "Arch" : "HVM64"  },
            "m4.large"    : { "Arch" : "HVM64"  },
            "m4.xlarge"   : { "Arch" : "HVM64"  },
            "m4.2xlarge"  : { "Arch" : "HVM64"  },
            "m4.4xlarge"  : { "Arch" : "HVM64"  },
            "m4.10xlarge" : { "Arch" : "HVM64"  },
            "c1.medium"   : { "Arch" : "HVM64"  },
            "c1.xlarge"   : { "Arch" : "HVM64"  },
            "c3.large"    : { "Arch" : "HVM64"  },
            "c3.xlarge"   : { "Arch" : "HVM64"  },
            "c3.2xlarge"  : { "Arch" : "HVM64"  },
            "c3.4xlarge"  : { "Arch" : "HVM64"  },
            "c3.8xlarge"  : { "Arch" : "HVM64"  },
            "c4.large"    : { "Arch" : "HVM64"  },
            "c4.xlarge"   : { "Arch" : "HVM64"  },
            "c4.2xlarge"  : { "Arch" : "HVM64"  },
            "c4.4xlarge"  : { "Arch" : "HVM64"  },
            "c4.8xlarge"  : { "Arch" : "HVM64"  },
            "g2.2xlarge"  : { "Arch" : "HVM64"  },
            "g2.8xlarge"  : { "Arch" : "HVM64"  },
            "r3.large"    : { "Arch" : "HVM64"  },
            "r3.xlarge"   : { "Arch" : "HVM64"  },
            "r3.2xlarge"  : { "Arch" : "HVM64"  },
            "r3.4xlarge"  : { "Arch" : "HVM64"  },
            "r3.8xlarge"  : { "Arch" : "HVM64"  },
            "i2.xlarge"   : { "Arch" : "HVM64"  },
            "i2.2xlarge"  : { "Arch" : "HVM64"  },
            "i2.4xlarge"  : { "Arch" : "HVM64"  },
            "i2.8xlarge"  : { "Arch" : "HVM64"  },
            "d2.xlarge"   : { "Arch" : "HVM64"  },
            "d2.2xlarge"  : { "Arch" : "HVM64"  },
            "d2.4xlarge"  : { "Arch" : "HVM64"  },
            "d2.8xlarge"  : { "Arch" : "HVM64"  },
            "hi1.4xlarge" : { "Arch" : "HVM64"  },
            "hs1.8xlarge" : { "Arch" : "HVM64"  },
            "cr1.8xlarge" : { "Arch" : "HVM64"  },
            "cc2.8xlarge" : { "Arch" : "HVM64"  }
        },
        "AWSRegionArch2AMI": {
            "us-east-1"       : { "HVM64": "ami-74a73263" },
            "us-west-2"       : { "HVM64": "ami-2426e944" },
            "us-west-1"       : { "HVM64": "ami-6d0b4b0d" },
            "eu-west-1"       : { "HVM64": "ami-6fd5b81c" },
            "eu-central-1"    : { "HVM64": "ami-3f649050" },
            "ap-northeast-1"  : { "HVM64": "ami-760ff517" },
            "ap-northeast-2"  : { "HVM64": "ami-f3f13b9d" },
            "ap-southeast-1"  : { "HVM64": "ami-eceb348f" },
            "ap-southeast-2"  : { "HVM64": "ami-0b497c68" },
            "sa-east-1"       : { "HVM64": "ami-f1be299d" }
        }
    },
    "Resources": {
        "LoadBalancerSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "GroupDescription" : "Setup Ingress/Egress for Windows Load Balancer",
                "VpcId" : { "Ref" : "VPC" },
                "SecurityGroupIngress" : [ { "IpProtocol" : "tcp", "FromPort" : "80", "ToPort" : "80", "CidrIp" : "0.0.0.0/0" },
                                           { "IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0" } ],
                "SecurityGroupEgress" : [ { "IpProtocol" : "tcp", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" } ],
                "Tags" : [
                    { "Key" : "Name", "Value" : "Windows-ELB-SecurityGroup" }
                ]
            }
        },
        "ElasticLoadBalancer" : {
            "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties" : {
                "Subnets" : [ { "Ref" : "SubnetA" },{ "Ref" : "SubnetB" },{ "Ref" : "SubnetC" } ],
                "SecurityGroups" : [ { "Ref" : "LoadBalancerSecurityGroup" } ],
                "LBCookieStickinessPolicy" : [
                    {
                        "PolicyName" : "PublicELBCookieStickinessPolicy",
                        "CookieExpirationPeriod" : "3600"
                    }
                ],
                "Listeners" : [
                    {
                        "InstancePort": "80",
                        "LoadBalancerPort": "80",
                        "InstanceProtocol": "HTTPS",
                        "Protocol": "HTTPS",
                        "PolicyNames" : [ "PublicELBCookieStickinessPolicy" ]
                    }
                ],
                "HealthCheck" : {
                    "Target" : "HTTP:80/index.html",
                    "HealthyThreshold" : "2",
                    "UnhealthyThreshold" : "10",
                    "Interval" : "90",
                    "Timeout" : "60"
                },
                "Tags" : [
                    { "Key" : "Name", "Value" : "Windows-ELB" }
                ]
            }
        },
        "AutoScaleLaunchConfiguration" : {
            "Type" : "AWS::AutoScaling::LaunchConfiguration",
            "Properties" : {
                "KeyName" : { "Ref" : "KeyName" },
                "ImageId" : { "Fn::FindInMap" : [ "AWSRegionArch2AMI", { "Ref" : "AWS::Region" },
                            { "Fn::FindInMap" : [ "AWSInstanceType2Arch", { "Ref" : "InstanceType" }, "Arch" ] } ] },
                "AssociatePublicIpAddress" : "true",
                "InstanceType"   : { "Ref" : "InstanceType" },
                "SecurityGroups" : [ {"Ref" : "RDPSecurityGroup"} ]
            }
        },
        "WindowsScaleGroup" : {
            "Type" : "AWS::AutoScaling::AutoScalingGroup",
            "Properties" : {
                "AvailabilityZones" : { "Fn::GetAZs" : ""},
                "VPCZoneIdentifier": [ { "Ref" : "SubnetA" },{ "Ref" : "SubnetB" },{ "Ref" : "SubnetC" } ],
                "LaunchConfigurationName" : {"Ref": "AutoScaleLaunchConfiguration"},
                "MinSize" : "1",
                "MaxSize" : "2",
                "DesiredCapacity" : "1",
                "LoadBalancerNames" : { "Ref" : "ElasticLoadBalancer" },
                "Tags" : [{ "Key" : "Name", "Value" : "Widnows-Scale-Group", "PropagateAtLaunch":"true" }]
            }
        }
    },
    "Outputs": {
    }
}
